Bootstrap: docker
From: ubuntu:22.04

%files
    /home/jtian/src/516-singularity/cmake-3.25.1-linux-x86_64.tar.gz /root

%environment
    export SINGULARITY_MPICH_DIR=/usr
    export PATH=/root/cmake-3.25.1-linux-x86_64/bin:$PATH

%post
    apt-get -y update && DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential git wget sudo
    cd /root
	wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
	sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
	wget https://developer.download.nvidia.com/compute/cuda/11.5.2/local_installers/cuda-repo-ubuntu2004-11-5-local_11.5.2-495.29.05-1_amd64.deb
	sudo dpkg -i cuda-repo-ubuntu2004-11-5-local_11.5.2-495.29.05-1_amd64.deb
	sudo apt-key add /var/cuda-repo-ubuntu2004-11-5-local/7fa2af80.pub
	sudo apt-get update
	sudo apt-get -y install cuda
    tar zxvf cmake-3.25.1-linux-x86_64.tar.gz
    git clone https://github.com/szcompressor/cuSZ.git cusz-latest
    cd cusz-latest
    mkdir build
    cd build
    /root/cmake-3.25.1-linux-x86_64/bin/cmake .. -DCUSZ_BUILD_EXAMPLES=on -DCMAKE_BUILD_TYPE=Release -DCUSZ_BUILD_TESTS=on -DCMAKE_CUDA_ARCHITECTURES="75;80;86" 
    make -j


%runscript
    exec /root/cusz-latest/build/cusz
